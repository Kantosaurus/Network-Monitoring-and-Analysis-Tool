"""
WiFi Penetration Testing API

For authorized security testing only!
REST API for WiFi security testing capabilities.
"""

from flask import Flask, request, jsonify
from flask_cors import CORS
import os
import logging
from typing import Dict, Any
import traceback

from wifi_scanner import WiFiScanner, SecurityType
from handshake_capture import HandshakeCapture, HandshakeStatus
from wps_attack import WPSAttack, WPSAttackType, WPSStatus
from password_cracker import PasswordCracker, AttackMode, CrackStatus

# Setup logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Create Flask app
app = Flask(__name__)
CORS(app)

# Global instances
scanner = None
handshake_capturer = None
wps_attacker = None
password_cracker = None

# Configuration
INTERFACE = os.environ.get('WIFI_INTERFACE', 'wlan0')
MONITOR_INTERFACE = os.environ.get('WIFI_MONITOR_INTERFACE', 'wlan0mon')
WORDLIST_DIR = os.environ.get('WORDLIST_DIR', '/usr/share/wordlists')
HANDSHAKE_DIR = os.environ.get('HANDSHAKE_DIR', '/tmp/handshakes')


def init_tools():
    """Initialize pentesting tools"""
    global scanner, handshake_capturer, wps_attacker, password_cracker

    # Check authorization
    if not os.environ.get('WIFI_PENTEST_ACKNOWLEDGED'):
        raise PermissionError(
            "⚠️ You must acknowledge the legal warning before using this tool.\n"
            "See LEGAL_WARNING.md and set WIFI_PENTEST_ACKNOWLEDGED=1"
        )

    try:
        logger.info("Initializing WiFi penetration testing tools...")

        scanner = WiFiScanner(interface=INTERFACE, monitor_mode=False)
        handshake_capturer = HandshakeCapture(
            interface=MONITOR_INTERFACE,
            output_dir=HANDSHAKE_DIR
        )
        wps_attacker = WPSAttack(interface=MONITOR_INTERFACE)
        password_cracker = PasswordCracker(wordlist_dir=WORDLIST_DIR)

        logger.info("✓ All tools initialized successfully")
    except Exception as e:
        logger.error(f"Failed to initialize tools: {e}")
        raise


@app.route('/api/pentesting/health', methods=['GET'])
def health_check():
    """Check API health"""
    try:
        return jsonify({
            'status': 'ok',
            'interface': INTERFACE,
            'monitor_interface': MONITOR_INTERFACE,
            'tools_initialized': all([scanner, handshake_capturer, wps_attacker, password_cracker]),
            'wordlist_dir': WORDLIST_DIR,
            'handshake_dir': HANDSHAKE_DIR
        })
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e)}), 500


@app.route('/api/pentesting/scan', methods=['POST'])
def scan_networks():
    """
    Scan for WiFi networks

    Request:
    {
        "duration": 10
    }

    Response:
    {
        "success": true,
        "networks": [
            {
                "ssid": "NetworkName",
                "bssid": "00:11:22:33:44:55",
                "channel": 6,
                "signal_strength": -50,
                "security": "WPA2",
                "encryption": "CCMP",
                "wps": false,
                "clients": 3,
                "security_analysis": {
                    "vulnerabilities": [],
                    "recommendations": [],
                    "risk_level": "Low"
                }
            }
        ]
    }
    """
    try:
        data = request.json or {}
        duration = data.get('duration', 10)

        logger.info(f"Scanning for WiFi networks (duration: {duration}s)...")

        if not scanner:
            return jsonify({
                'success': False,
                'error': 'Scanner not initialized'
            }), 500

        networks = scanner.scan_networks(duration=duration)

        # Convert to dict and add security analysis
        result = []
        for net in networks:
            analysis = scanner.analyze_security(net)

            result.append({
                'ssid': net.ssid,
                'bssid': net.bssid,
                'channel': net.channel,
                'signal_strength': net.signal_strength,
                'security': net.security.value,
                'encryption': net.encryption,
                'wps': net.wps,
                'clients': net.clients,
                'security_analysis': analysis
            })

        logger.info(f"Found {len(result)} networks")

        return jsonify({
            'success': True,
            'networks': result,
            'count': len(result)
        })

    except Exception as e:
        logger.error(f"Scan error: {e}")
        logger.error(traceback.format_exc())
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500


@app.route('/api/pentesting/capture-handshake', methods=['POST'])
def capture_handshake():
    """
    Capture WPA/WPA2 handshake

    Request:
    {
        "bssid": "00:11:22:33:44:55",
        "ssid": "NetworkName",
        "channel": 6,
        "timeout": 300,
        "deauth": true,
        "deauth_count": 10
    }

    Response:
    {
        "success": true,
        "status": "complete",
        "ssid": "NetworkName",
        "bssid": "00:11:22:33:44:55",
        "capture_file": "/tmp/handshakes/handshake_NetworkName_1234567890-01.cap",
        "eapol_frames": 4,
        "client_mac": "aa:bb:cc:dd:ee:ff",
        "duration": 45.2
    }
    """
    try:
        data = request.json

        bssid = data.get('bssid')
        ssid = data.get('ssid')
        channel = data.get('channel')
        timeout = data.get('timeout', 300)
        deauth = data.get('deauth', True)
        deauth_count = data.get('deauth_count', 10)

        if not all([bssid, ssid, channel]):
            return jsonify({
                'success': False,
                'error': 'Missing required fields: bssid, ssid, channel'
            }), 400

        logger.info(f"Capturing handshake for {ssid} ({bssid})...")

        if not handshake_capturer:
            return jsonify({
                'success': False,
                'error': 'Handshake capturer not initialized'
            }), 500

        result = handshake_capturer.capture_handshake(
            target_bssid=bssid,
            target_ssid=ssid,
            channel=channel,
            timeout=timeout,
            deauth=deauth,
            deauth_count=deauth_count
        )

        return jsonify({
            'success': result.status == HandshakeStatus.COMPLETE,
            'status': result.status.value,
            'ssid': result.ssid,
            'bssid': result.bssid,
            'capture_file': result.capture_file,
            'eapol_frames': result.eapol_frames,
            'client_mac': result.client_mac,
            'timestamp': result.timestamp
        })

    except Exception as e:
        logger.error(f"Handshake capture error: {e}")
        logger.error(traceback.format_exc())
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500


@app.route('/api/pentesting/wps-attack', methods=['POST'])
def wps_attack():
    """
    Test WPS vulnerability

    Request:
    {
        "bssid": "00:11:22:33:44:55",
        "ssid": "NetworkName",
        "channel": 6,
        "attack_type": "pixie_dust",
        "timeout": 600
    }

    Response:
    {
        "success": true,
        "status": "success",
        "ssid": "NetworkName",
        "bssid": "00:11:22:33:44:55",
        "wps_pin": "12345670",
        "wpa_psk": "password123",
        "attack_type": "pixie_dust",
        "duration": 15.3
    }
    """
    try:
        data = request.json

        bssid = data.get('bssid')
        ssid = data.get('ssid')
        channel = data.get('channel')
        attack_type_str = data.get('attack_type', 'pixie_dust')
        timeout = data.get('timeout', 600)

        if not all([bssid, ssid, channel]):
            return jsonify({
                'success': False,
                'error': 'Missing required fields: bssid, ssid, channel'
            }), 400

        # Parse attack type
        attack_type = WPSAttackType[attack_type_str.upper()]

        logger.info(f"Testing WPS on {ssid} ({bssid}) with {attack_type.value}...")

        if not wps_attacker:
            return jsonify({
                'success': False,
                'error': 'WPS attacker not initialized'
            }), 500

        result = wps_attacker.test_wps(
            target_bssid=bssid,
            target_ssid=ssid,
            channel=channel,
            attack_type=attack_type,
            timeout=timeout
        )

        return jsonify({
            'success': result.status == WPSStatus.SUCCESS,
            'status': result.status.value,
            'ssid': result.ssid,
            'bssid': result.bssid,
            'wps_pin': result.wps_pin,
            'wpa_psk': result.wpa_psk,
            'attack_type': result.attack_type.value if result.attack_type else None,
            'duration': result.duration,
            'attempts': result.attempts
        })

    except Exception as e:
        logger.error(f"WPS attack error: {e}")
        logger.error(traceback.format_exc())
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500


@app.route('/api/pentesting/crack-password', methods=['POST'])
def crack_password():
    """
    Crack WPA/WPA2 password

    Request:
    {
        "capture_file": "/tmp/handshakes/handshake_NetworkName_1234567890-01.cap",
        "ssid": "NetworkName",
        "bssid": "00:11:22:33:44:55",
        "wordlist": "/usr/share/wordlists/rockyou.txt",
        "attack_mode": "dictionary",
        "timeout": 3600
    }

    Response:
    {
        "success": true,
        "status": "success",
        "ssid": "NetworkName",
        "bssid": "00:11:22:33:44:55",
        "password": "password123",
        "cracker": "hashcat",
        "attack_mode": "dictionary",
        "duration": 125.4,
        "attempts": 1500000,
        "hash_rate": 12000.0
    }
    """
    try:
        data = request.json

        capture_file = data.get('capture_file')
        ssid = data.get('ssid')
        bssid = data.get('bssid')
        wordlist = data.get('wordlist')
        attack_mode_str = data.get('attack_mode', 'dictionary')
        timeout = data.get('timeout')

        if not all([capture_file, ssid, bssid]):
            return jsonify({
                'success': False,
                'error': 'Missing required fields: capture_file, ssid, bssid'
            }), 400

        # Parse attack mode
        attack_mode = AttackMode[attack_mode_str.upper()]

        logger.info(f"Cracking password for {ssid} ({bssid})...")

        if not password_cracker:
            return jsonify({
                'success': False,
                'error': 'Password cracker not initialized'
            }), 500

        result = password_cracker.crack_password(
            capture_file=capture_file,
            ssid=ssid,
            bssid=bssid,
            wordlist=wordlist,
            attack_mode=attack_mode,
            timeout=timeout
        )

        return jsonify({
            'success': result.status == CrackStatus.SUCCESS,
            'status': result.status.value,
            'ssid': result.ssid,
            'bssid': result.bssid,
            'password': result.password,
            'cracker': result.cracker.value if result.cracker else None,
            'attack_mode': result.attack_mode.value if result.attack_mode else None,
            'duration': result.duration,
            'attempts': result.attempts,
            'hash_rate': result.hash_rate
        })

    except Exception as e:
        logger.error(f"Password cracking error: {e}")
        logger.error(traceback.format_exc())
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500


@app.route('/api/pentesting/full-attack', methods=['POST'])
def full_attack():
    """
    Full automated attack workflow

    Tries multiple attack vectors in sequence:
    1. WPS Pixie Dust (fastest)
    2. WPS NULL PIN (fast)
    3. Handshake capture + dictionary attack (slow)

    Request:
    {
        "bssid": "00:11:22:33:44:55",
        "ssid": "NetworkName",
        "channel": 6,
        "wordlist": "/usr/share/wordlists/rockyou.txt",
        "timeout": 3600
    }

    Response:
    {
        "success": true,
        "method": "wps_pixie_dust",
        "password": "password123",
        "wps_pin": "12345670",
        "duration": 15.3,
        "attempts": [
            {"method": "wps_pixie_dust", "status": "success", "duration": 15.3}
        ]
    }
    """
    try:
        data = request.json

        bssid = data.get('bssid')
        ssid = data.get('ssid')
        channel = data.get('channel')
        wordlist = data.get('wordlist')
        timeout = data.get('timeout', 3600)

        if not all([bssid, ssid, channel]):
            return jsonify({
                'success': False,
                'error': 'Missing required fields: bssid, ssid, channel'
            }), 400

        logger.info(f"Starting full attack on {ssid} ({bssid})...")

        attempts = []
        start_time = time.time()

        # 1. Try WPS Pixie Dust (fastest, ~30 seconds)
        logger.info("Attempting WPS Pixie Dust attack...")
        wps_result = wps_attacker.test_wps(
            target_bssid=bssid,
            target_ssid=ssid,
            channel=channel,
            attack_type=WPSAttackType.PIXIE_DUST,
            timeout=60
        )

        attempts.append({
            'method': 'wps_pixie_dust',
            'status': wps_result.status.value,
            'duration': wps_result.duration
        })

        if wps_result.status == WPSStatus.SUCCESS:
            logger.info("✓ WPS Pixie Dust successful!")
            return jsonify({
                'success': True,
                'method': 'wps_pixie_dust',
                'password': wps_result.wpa_psk,
                'wps_pin': wps_result.wps_pin,
                'duration': time.time() - start_time,
                'attempts': attempts
            })

        # 2. Try WPS NULL PIN (fast, ~1 minute)
        if wps_result.status != WPSStatus.WPS_LOCKED:
            logger.info("Attempting WPS NULL PIN attack...")
            wps_result = wps_attacker.test_wps(
                target_bssid=bssid,
                target_ssid=ssid,
                channel=channel,
                attack_type=WPSAttackType.NULL_PIN,
                timeout=120
            )

            attempts.append({
                'method': 'wps_null_pin',
                'status': wps_result.status.value,
                'duration': wps_result.duration
            })

            if wps_result.status == WPSStatus.SUCCESS:
                logger.info("✓ WPS NULL PIN successful!")
                return jsonify({
                    'success': True,
                    'method': 'wps_null_pin',
                    'password': wps_result.wpa_psk,
                    'wps_pin': wps_result.wps_pin,
                    'duration': time.time() - start_time,
                    'attempts': attempts
                })

        # 3. Capture handshake and crack (slow, minutes to hours)
        logger.info("Attempting handshake capture + dictionary attack...")

        handshake_result = handshake_capturer.capture_handshake(
            target_bssid=bssid,
            target_ssid=ssid,
            channel=channel,
            timeout=300,
            deauth=True
        )

        attempts.append({
            'method': 'handshake_capture',
            'status': handshake_result.status.value,
            'eapol_frames': handshake_result.eapol_frames
        })

        if handshake_result.status == HandshakeStatus.COMPLETE:
            logger.info("✓ Handshake captured, starting dictionary attack...")

            crack_result = password_cracker.crack_password(
                capture_file=handshake_result.capture_file,
                ssid=ssid,
                bssid=bssid,
                wordlist=wordlist,
                attack_mode=AttackMode.DICTIONARY,
                timeout=timeout
            )

            attempts.append({
                'method': 'dictionary_attack',
                'status': crack_result.status.value,
                'duration': crack_result.duration,
                'attempts': crack_result.attempts
            })

            if crack_result.status == CrackStatus.SUCCESS:
                logger.info("✓ Password cracked!")
                return jsonify({
                    'success': True,
                    'method': 'dictionary_attack',
                    'password': crack_result.password,
                    'duration': time.time() - start_time,
                    'attempts': attempts
                })

        # All methods failed
        logger.info("✗ All attack methods failed")
        return jsonify({
            'success': False,
            'error': 'All attack methods failed',
            'duration': time.time() - start_time,
            'attempts': attempts
        })

    except Exception as e:
        logger.error(f"Full attack error: {e}")
        logger.error(traceback.format_exc())
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500


@app.route('/api/pentesting/list-handshakes', methods=['GET'])
def list_handshakes():
    """List captured handshakes"""
    try:
        if not handshake_capturer:
            return jsonify({
                'success': False,
                'error': 'Handshake capturer not initialized'
            }), 500

        handshakes = handshake_capturer.list_captured_handshakes()

        return jsonify({
            'success': True,
            'handshakes': handshakes,
            'count': len(handshakes)
        })

    except Exception as e:
        logger.error(f"List handshakes error: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500


@app.route('/api/pentesting/estimate-crack-time', methods=['POST'])
def estimate_crack_time():
    """
    Estimate password cracking time

    Request:
    {
        "wordlist": "/usr/share/wordlists/rockyou.txt",
        "hash_rate": 100000
    }

    Response:
    {
        "success": true,
        "word_count": 14344391,
        "hash_rate": 100000,
        "seconds": 143.44,
        "minutes": 2.39,
        "hours": 0.04,
        "days": 0.002
    }
    """
    try:
        data = request.json

        wordlist = data.get('wordlist')
        hash_rate = data.get('hash_rate')

        if not wordlist:
            return jsonify({
                'success': False,
                'error': 'Missing required field: wordlist'
            }), 400

        if not password_cracker:
            return jsonify({
                'success': False,
                'error': 'Password cracker not initialized'
            }), 500

        estimate = password_cracker.estimate_time(wordlist, hash_rate)

        return jsonify({
            'success': True,
            **estimate
        })

    except Exception as e:
        logger.error(f"Estimate error: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500


if __name__ == '__main__':
    import time

    # Display legal warning
    print("\n" + "="*70)
    print("⚠️  WiFi Penetration Testing API")
    print("="*70)
    print("LEGAL WARNING: For authorized security testing only!")
    print("See LEGAL_WARNING.md for full legal disclaimer.")
    print("="*70 + "\n")

    # Initialize tools
    try:
        init_tools()
    except Exception as e:
        logger.error(f"Failed to initialize: {e}")
        logger.error("Please check your configuration and ensure WIFI_PENTEST_ACKNOWLEDGED=1")
        exit(1)

    # Start server
    logger.info("Starting WiFi Penetration Testing API on http://localhost:5001")
    app.run(host='0.0.0.0', port=5001, debug=True)
